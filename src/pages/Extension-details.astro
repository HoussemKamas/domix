---
import Layout from '../layouts/Layout.astro';
import fs from 'fs';
import path from 'path';

// قراءة domix.json
const dataPath = path.join(process.cwd(), 'src/data/domix.json');

type ExtensionItem = {
  id?: number | string;
  name?: string;
  title?: string;
  description?: string;
  category?: string;
  type?: string;
  price?: number | string;
  logo?: string;
  poster?: string;
  video?: string;
  download_url?: string;
  is_free?: boolean;
};

type DomixData = {
  domains?: any[];
  prompts?: any[];
  code?: any[];
  extensions: ExtensionItem[];
};

let data: DomixData = { extensions: [] };

try {
  const raw = fs.readFileSync(dataPath, 'utf-8');
  const parsed = JSON.parse(raw);

  data = {
    domains: parsed.domains ?? [],
    prompts: parsed.prompts ?? [],
    code: parsed.code ?? [],
    extensions: parsed.extensions ?? []
  };
} catch (e) {
  console.error('Failed to read domix.json', e);
}

// سنختار الإضافة في المتصفح بناءً على الـ hash
const allExtensions = [...(data.extensions ?? [])];
---

<Layout title="DOMIX — Extension Details">
  <div class="bg-blob"></div>
  <div class="bg-grid"></div>

  <main
    class="page"
    data-extensions={JSON.stringify(
      allExtensions.map((ext) => {
        const priceNum = Number(ext.price ?? 0);
        const isFree = Boolean(ext.is_free || !priceNum || priceNum === 0);
        return {
          id: ext.id ?? '',
          name: ext.name ?? ext.title ?? 'Extension',
          title: ext.title ?? ext.name ?? 'Extension',
          description:
            ext.description ??
            'A browser extension from DOMIX to boost your workflow.',
          category: ext.category ?? ext.type ?? 'Extension',
          price: ext.price ?? 0,
          is_free: isFree,
          logo: ext.logo ?? ext.poster ?? '',
          video: ext.video ?? '',
          download_url: ext.download_url ?? ''
        };
      })
    )}
  >
    <div class="crumb">
      <a href="/extensions">← All Extensions</a> /
      <span id="crumbLabel"> Extension details</span>
    </div>

    <div class="head-row">
      <h1 class="ext-title" id="extTitle">Extension</h1>
    </div>

    <div class="layout">
      <!-- يسار: الوصف -->
      <section>
        <div class="panel">
          <p class="desc" id="extDescription">
            A browser extension from DOMIX to help you work faster and stay
            focused.
          </p>

          <ul class="meta-list">
            <li>
              <span class="label">Category</span>
              <span id="extCategory">Extension</span>
            </li>
          </ul>

          <div class="pricing-box" id="pricingBox">
            <div class="price-row">
              <div class="price-main">
                <span class="price-label" id="priceLabel">Status</span>
                <span
                  class="price-value free"
                  id="priceValue"
                >
                  Free
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- يمين: فيديو + أزرار -->
      <section class="media-block">
        <h2>Preview</h2>

        <div class="video-frame">
          <video id="extVideo" controls poster="/images/extension-placeholder.png">
            <source id="extVideoSource" src="" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>

        <div class="panel btn-panel">
          <div class="btn-row">
            <a
              class="btn-buy"
              id="buyBtn"
              href="https://www.facebook.com/houssem.kamas.2025"
              target="_blank"
              rel="noopener"
            >
              <span class="icon"></span>
              <span>Buy on Facebook</span>
            </a>

            <a
              class="btn-download"
              id="downloadBtn"
              href="#"
              download
              target="_blank"
              rel="noopener"
              style="display:none;"
            >
              <span class="icon"></span>
              <span>Download Extension</span>
            </a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <style>
    :root{
      --bg-dark:#050505;
      --panel: rgba(255,255,255,.04);
      --panel-border: rgba(255,255,255,.10);
      --text-dim:#a0a0a0;

      --neon-blue:#00f3ff;
      --neon-green:#00ff88;
      --neon-orange:#ff9d00;

      --radius: 22px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at 5% 0%, #151629, #050505 55%, #020209 100%);
      color:#fff;
      overflow-x:hidden;
    }

    .bg-grid{
      position:fixed;
      inset:0;
      background-image:
        linear-gradient(rgba(0,243,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,243,255,.06) 1px, transparent 1px);
      background-size: 64px 64px;
      opacity:.16;
      mix-blend-mode:screen;
      animation:gridShift 20s linear infinite;
      z-index:-3;
    }
    @keyframes gridShift{
      0%{ transform:translateY(0) scale(1); }
      100%{ transform:translateY(60px) scale(1.03); }
    }

    .bg-blob{
      position:fixed;
      inset:-10%;
      background:
        radial-gradient(circle at 10% 30%, rgba(0,243,255,.28), transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(188,19,254,.26), transparent 60%);
      opacity:.7;
      filter:blur(10px);
      mix-blend-mode:screen;
      animation:blobDrift 18s ease-in-out infinite alternate;
      z-index:-4;
    }
    @keyframes blobDrift{
      0%{ transform:translate3d(0,0,0); opacity:.5; }
      50%{ transform:translate3d(-10px,-14px,0); opacity:.9; }
      100%{ transform:translate3d(12px,8px,0); opacity:.6; }
    }

    .page{
      position:relative;
      max-width:1120px;
      margin:0 auto;
      padding:32px 18px 64px;
    }

    .crumb{
      margin-bottom:20px;
      font-size:.85rem;
      color:rgba(255,255,255,.65);
    }
    .crumb a{
      color:var(--neon-blue);
      text-decoration:none;
    }
    .crumb a:hover{
      text-decoration:underline;
    }

    .head-row{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }

    h1.ext-title{
      font-size: clamp(2rem, 3.4vw, 2.6rem);
      letter-spacing:.06em;
      text-transform:uppercase;
      text-shadow:0 0 24px rgba(255,255,255,.28);
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap:26px;
      align-items:flex-start;
      margin-top:8px;
    }

    .desc{
      font-size:.98rem;
      line-height:1.7;
      color:var(--text-dim);
      margin-bottom:20px;
    }

    .meta-list{
      list-style:none;
      font-size:.86rem;
      color:rgba(255,255,255,.75);
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
      margin-bottom:10px;
      padding-left:0;
    }
    .meta-list span.label{
      opacity:.7;
      text-transform:uppercase;
      letter-spacing:.16em;
      font-size:.75rem;
    }

    .panel{
      border-radius:var(--radius);
      padding:16px 16px 14px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter:blur(14px);
      box-shadow:0 18px 46px rgba(0,0,0,.85);
    }

    .media-block{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .media-block h2{
      font-size:1rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      opacity:.82;
    }

    .video-frame{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background:radial-gradient(circle at 10% 0%, rgba(0,243,255,.4), transparent 60%);
      box-shadow:0 14px 36px rgba(0,0,0,.85);
    }
    .video-frame video{
      display:block;
      width:100%;
      height:auto;
      background:#000;
    }

    .pricing-box{
      margin-top:18px;
      padding:14px 16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.2);
      background:linear-gradient(135deg, rgba(0,0,0,.9), rgba(6,22,25,.96));
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .price-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .price-main{
      display:flex;
      align-items:baseline;
      gap:8px;
    }

    .price-label{
      font-size:.82rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.75;
    }

    .price-value{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:.06em;
    }

    .price-value.free{
      color:var(--neon-green);
      text-shadow:0 0 16px rgba(0,255,136,.6);
    }
    .price-value.paid{
      color:var(--neon-orange);
      text-shadow:0 0 16px rgba(255,157,0,.6);
    }

    .btn-panel{
      padding-top:18px;
    }
    .btn-row{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .btn-buy,
    .btn-download{
      align-self:flex-start;
      padding:9px 20px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
      color:#050505;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
    }
    .btn-buy{
      background:linear-gradient(135deg, #ffce4d, var(--neon-orange));
      box-shadow:
        0 0 18px rgba(255,157,0,.8),
        0 12px 28px rgba(0,0,0,.8);
    }
    .btn-download{
      background:linear-gradient(135deg, #00ff88, #00f3ff);
      box-shadow:
        0 0 18px rgba(0,255,136,.8),
        0 12px 28px rgba(0,0,0,.8);
    }
    .btn-buy:hover,
    .btn-download:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }

    .btn-buy .icon,
    .btn-download .icon{
      width:16px;
      height:16px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #fff, #7a3a00);
      box-shadow:0 0 10px rgba(0,0,0,.9);
    }

    @media (max-width:820px){
      .layout{
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    function parseExtensions(){
      const page = document.querySelector('.page');
      if(!page) return [];
      try{
        const raw = page.getAttribute('data-extensions') || '[]';
        return JSON.parse(raw);
      }catch(e){
        console.error('Failed to parse extensions data', e);
        return [];
      }
    }

    function getExtensionFromHash(list){
      const hash = window.location.hash.replace('#','').trim();
      if(!hash) return list[0] || null;

      const byId = list.find(e => String(e.id) === hash);
      if(byId) return byId;

      const lower = hash.toLowerCase();
      const byName = list.find(e =>
        (e.name && e.name.toLowerCase() === lower) ||
        (e.title && e.title.toLowerCase() === lower)
      );
      return byName || list[0] || null;
    }

    function formatPrice(p){
      if(!p && p !== 0) return 'Free';
      const num = Number(p);
      if(!num) return 'Free';
      return '$' + num.toLocaleString();
    }

    function updateExtensionDetails(){
      const list = parseExtensions();
      if(!list.length) return;

      const item = getExtensionFromHash(list);
      if(!item) return;

      const name = item.name || item.title || 'Extension';
      const cat = item.category || 'Extension';
      const desc = item.description || '';
      const priceNum = Number(item.price ?? 0);
      const isFree = Boolean(item.is_free || !priceNum || priceNum === 0);
      const priceLabel = formatPrice(item.price);

      document.title = name + " — Extension Details";

      const titleEl = document.getElementById('extTitle');
      const crumbEl = document.getElementById('crumbLabel');
      const descEl = document.getElementById('extDescription');
      const catEl = document.getElementById('extCategory');
      const priceLabelEl = document.getElementById('priceLabel');
      const priceValueEl = document.getElementById('priceValue');
      const videoEl = document.getElementById('extVideo');
      const videoSource = document.getElementById('extVideoSource');
      const buyBtn = document.getElementById('buyBtn');
      const downloadBtn = document.getElementById('downloadBtn');

      if(titleEl) titleEl.textContent = name;
      if(crumbEl) crumbEl.textContent = ' ' + name;
      if(descEl) descEl.textContent = desc;
      if(catEl) catEl.textContent = cat;

      if(priceLabelEl) priceLabelEl.textContent = isFree ? 'Status' : 'Price';
      if(priceValueEl){
        priceValueEl.textContent = isFree ? 'Free' : priceLabel;
        priceValueEl.classList.toggle('free', isFree);
        priceValueEl.classList.toggle('paid', !isFree);
      }

      // تحديث الفيديو لو عندنا مسار
      if(item.video && videoSource && videoEl){
        videoSource.src = item.video;
        videoEl.load();
      }

      // منطق الأزرار: مجاني = زر تحميل، مدفوع = زر شراء فقط
      if(isFree){
        if(buyBtn) buyBtn.style.display = 'none';
        if(downloadBtn){
          downloadBtn.style.display = 'inline-flex';
          downloadBtn.href = item.download_url || '#';
        }
      } else{
        if(buyBtn) buyBtn.style.display = 'inline-flex';
        if(downloadBtn) downloadBtn.style.display = 'none';
      }
    }

    window.addEventListener('load', updateExtensionDetails);
    window.addEventListener('hashchange', updateExtensionDetails);
  </script>
</Layout>
